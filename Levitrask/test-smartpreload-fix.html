<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartPreload Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-link {
            display: inline-block;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            margin: 5px;
        }
        .test-link:hover {
            background-color: #0056b3;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>SmartPreload Fix Test</h1>
    <p>这个页面用于测试 smartPreload.js 中的修复是否有效。</p>

    <div class="test-section">
        <h2>测试链接悬停预加载</h2>
        <p>将鼠标悬停在下面的链接上，检查控制台是否有错误：</p>
        <a href="/en/blog" class="test-link">Blog Link</a>
        <a href="/en/news" class="test-link">News Link</a>
        <a href="/zh-CN/blog" class="test-link">中文博客</a>
        <div id="hover-status" class="status info">等待测试...</div>
    </div>

    <div class="test-section">
        <h2>测试事件目标检查</h2>
        <p>这些元素会触发各种事件来测试我们的修复：</p>
        <div id="test-container">
            <span>普通文本节点</span>
            <button id="test-button">测试按钮</button>
            <div id="test-div">测试 DIV</div>
        </div>
        <div id="event-status" class="status info">等待事件测试...</div>
    </div>

    <div class="test-section">
        <h2>控制台日志</h2>
        <div id="console-log" class="status info">
            检查浏览器控制台查看详细日志...
        </div>
    </div>

    <script type="module">
        // 导入修复后的 smartPreload 模块
        import { smartPreloadManager, preloadOnHover } from './src/utils/smartPreload.js';

        let errorCount = 0;
        let testCount = 0;

        // 捕获所有错误
        window.addEventListener('error', (e) => {
            errorCount++;
            console.error('捕获到错误:', e.error);
            updateStatus('console-log', `错误计数: ${errorCount}`, 'error');
        });

        // 测试悬停预加载
        function testHoverPreload() {
            console.log('开始测试悬停预加载...');
            
            // 初始化智能预加载管理器
            smartPreloadManager.init();
            
            // 测试 preloadOnHover 函数
            preloadOnHover('.test-link', '/test-resource');
            
            updateStatus('hover-status', '悬停预加载已初始化，请悬停链接测试', 'success');
        }

        // 测试事件目标检查
        function testEventTargets() {
            console.log('开始测试事件目标检查...');
            testCount = 0;
            
            // 模拟各种事件目标
            const testTargets = [
                document.getElementById('test-button'),
                document.getElementById('test-div'),
                document.createTextNode('text node'), // 文本节点
                null, // null 目标
                undefined, // undefined 目标
                { nodeType: 3 }, // 模拟非元素节点
                { nodeType: 1, matches: null }, // 没有 matches 方法的元素
            ];

            testTargets.forEach((target, index) => {
                testCount++;
                try {
                    // 模拟 mouseenter 事件
                    const mockEvent = {
                        target: target,
                        type: 'mouseenter'
                    };
                    
                    // 测试我们的安全检查
                    if (!mockEvent.target || mockEvent.target.nodeType !== 1) {
                        console.log(`测试 ${index + 1}: 安全检查通过 - 跳过非元素节点`);
                        return;
                    }
                    
                    console.log(`测试 ${index + 1}: 处理元素节点`, target);
                    
                } catch (error) {
                    console.error(`测试 ${index + 1} 失败:`, error);
                    errorCount++;
                }
            });
            
            updateStatus('event-status', `完成 ${testCount} 个事件目标测试`, 'success');
        }

        // 更新状态显示
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // 运行测试
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成，开始测试...');
            
            setTimeout(() => {
                testHoverPreload();
                testEventTargets();
                
                // 最终状态
                setTimeout(() => {
                    const finalMessage = errorCount === 0 
                        ? '✅ 所有测试通过，没有发现错误！' 
                        : `❌ 发现 ${errorCount} 个错误，请检查控制台`;
                    
                    updateStatus('console-log', finalMessage, errorCount === 0 ? 'success' : 'error');
                }, 1000);
            }, 500);
        });

        // 添加链接悬停监听器来显示预加载状态
        document.querySelectorAll('.test-link').forEach(link => {
            link.addEventListener('mouseenter', () => {
                updateStatus('hover-status', `悬停在: ${link.textContent} - 检查网络面板查看预加载请求`, 'info');
            });
        });
    </script>
</body>
</html>
